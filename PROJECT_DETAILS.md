# 厚東川氾濫監視システムv2.0 プロジェクト詳細

## プロジェクト概要
山口県宇部市の厚東川ダムおよび厚東川（持世寺）の水位・雨量データをリアルタイムで監視するWebアプリケーション。Yahoo! Weather APIによる降水強度予測機能を搭載。

## デプロイ情報
- **本番URL**: https://kotogawa-monitor-app-fjprveyn8fzb3mbffkwq6i.streamlit.app/
- **GitHubリポジトリ**: https://github.com/dobocreate/kotogawa-monitor-streamlit
- **ホスティング**: Streamlit Cloud
- **自動更新**: GitHub Actions（10分間隔）

## 技術スタック
- **フロントエンド**: Streamlit
- **バックエンド**: Python 3.9+
- **データ収集**: BeautifulSoup4 (Web scraping), Yahoo! Weather API
- **可視化**: Plotly (双軸グラフ対応)
- **データ処理**: pandas
- **CI/CD**: GitHub Actions
- **天気予報**: Yahoo! Weather API

## プロジェクト構造
```
kotogawa-monitor-streamlit/
├── streamlit_app.py          # メインアプリケーション
├── scripts/
│   ├── collect_data.py       # データ収集スクリプト
│   └── save_current_webfetch_data.py  # 手動データ取得
├── data/
│   ├── latest.json          # 最新データ
│   ├── history/             # 履歴データ (年/月/日/時刻.json)
│   └── logs/                # 実行ログ
├── .github/workflows/
│   ├── data_collection.yml  # 自動データ収集（10分間隔）
│   └── cleanup.yml          # 古いデータクリーンアップ（毎日）
├── requirements.txt         # Python依存関係
└── README.md               # プロジェクト説明

```

## データソース

### 山口県土木防災情報システム
1. **厚東川ダム（観測所コード: 015）**
   - URL: https://y-bousai.pref.yamaguchi.lg.jp/citizen/dam/kdm_table.aspx
   - パラメータ: `check=015&obsdt=YYYYMMDDHHmm&pop=1`
   - 取得データ: 貯水位、貯水率、流入量、全放流量

2. **厚東川・持世寺（観測所コード: 05067）**
   - URL: https://y-bousai.pref.yamaguchi.lg.jp/citizen/water/kwl_table.aspx
   - パラメータ: `check=05067&obsdt=YYYYMMDDHHmm&pop=1`
   - 取得データ: 河川水位、水位変化、警戒レベル

3. **雨量データ**
   - ダムページから同時取得
   - 取得データ: 60分雨量、累積雨量

### Yahoo! Weather API
4. **降水強度・天気予報**
   - 座標: 131.289496,34.079891（厚東川ダム付近）
   - 取得データ: 降水強度（観測値・予測値）、天気予報、降水確率
   - 更新間隔: 10分

## 主要機能

### 1. リアルタイム監視
- 現在の水位・雨量をメトリクスで表示
- 3セクション構成：河川情報、降雨情報、ダム情報
- 固定ヘッダー（システム名・監視状況常時表示）
- 観測時刻の表示

### 2. アラート機能
- 河川警戒レベル（水防団待機: 3.80m、氾濫注意: 5.00m、避難判断: 5.10m、氾濫危険: 5.50m）
- ダム貯水率警戒（警戒: 90%、危険: 95%）
- 雨量警戒（注意: 10mm/h、警戒: 30mm/h、危険: 50mm/h）

### 3. データ可視化
- 4つの時系列グラフ（Plotly双軸対応）
  - 河川水位・全放流量
  - ダム流入出量・累加雨量
  - ダム貯水位・時間雨量（降水強度含む）
  - Yahoo! Weather API（降水強度・時間雨量）
- データテーブル表示
- CSVダウンロード機能
- レスポンシブデザイン対応

### 4. 自動データ収集
- GitHub Actionsで10分ごとに実行（毎時3,13,23,33,43,53分）
- データ更新遅延を考慮した3分遅れの取得
- 自動的にGitHubリポジトリにコミット

### 5. 天気予報機能
- 今日・明日・明後日の詳細予報
- 週間天気予報（レスポンシブ対応）
- 降水確率のグラフ表示
- 警戒メッセージの自動表示

## 重要な実装詳細

### 時刻処理
```python
# 10分単位に丸めて、さらに10分前のデータを取得
current_time = datetime.now()
minutes = (current_time.minute // 10) * 10
observation_time = current_time.replace(minute=minutes, second=0, microsecond=0) - timedelta(minutes=10)
obsdt = observation_time.strftime('%Y%m%d%H%M')
```

### データ形式（latest.json）
```json
{
  "timestamp": "2025-06-25T13:27:59.512316+09:00",
  "data_time": "2025-06-25T13:20:00+09:00",
  "dam": {
    "water_level": 36.75,
    "storage_rate": 97.1,
    "inflow": 68.26,
    "outflow": 65.24,
    "storage_change": null
  },
  "river": {
    "water_level": 3.08,
    "level_change": 0.0,
    "status": "正常"
  },
  "rainfall": {
    "hourly": 0,
    "cumulative": 0,
    "change": 0
  },
  "weather": {
    "today": {
      "weather_code": "214",
      "weather_text": "くもり　昼過ぎ　から　雨　所により　雷　を伴う",
      "temp_max": 28,
      "temp_min": 28,
      "precipitation_probability": [60, 70],
      "precipitation_times": ["12時", "18時"]
    },
    "weekly_forecast": [...]
  },
  "precipitation_intensity": {
    "observation": [{
      "datetime": "2025-06-25T13:02:00+09:00",
      "intensity": 0.0
    }],
    "forecast": [{
      "datetime": "2025-06-25T13:03:00+09:00",
      "intensity": 0.0
    }],
    "update_time": "2025-06-25T13:27:59.512161+09:00"
  }
}
```

## 最近の主要変更

### 2025年6月27日 v2.4リリース
1. **雨量データエラー処理の改善**
   - 雨量データがnullの場合もエラーとせず正常データとして処理
   - daily_summary.json作成機能を無効化（未使用機能）
   - daily_summaryファイルの読み込みスキップ処理追加
   - エラーファイル26件を削除（error_*.json、daily_summary.json）
   - エラー表示が23件→0件に大幅改善

2. **バグ修正**
   - 雨量データnull時のTypeError修正（アラートチェック時の比較演算子エラー）
   - nullチェックを追加してアプリクラッシュを防止

3. **モバイルサイドバー問題の修正**
   - 複雑なCSS/JavaScript処理を削除
   - initial_sidebar_state="collapsed"に変更（全デバイスで初期状態は閉じる）
   - Streamlitの標準動作に準拠してサイドバー開閉問題を解決

### 2025年6月27日 v2.3リリース
1. **UI/UX改善**
   - システムヘッダー上部の余分なスペースを削除（st_autorefresh配置変更）
   - サイドバー全面リニューアル：
     - 「設定」を「更新設定」に変更
     - 表示期間を「表示設定」セクションに移動
     - システム情報を親expanderとした入れ子構造実装
     - 観測状況も折りたたみ可能に（デフォルトで展開）
   - 「Yahoo! Weather API」を「降水強度・時間雨量」に名称変更
   - データソースの改行追加で可読性向上

2. **モバイル対応強化**
   - CSSメディアクエリでモバイル端末（≤768px）時にサイドバー初期非表示
   - モバイルユーザビリティの大幅改善

3. **免責事項追加**
   - サイドバー下部に2行の免責事項を追加
   - 参考情報であることと責任範囲を明確化

4. **サイドバー構造の最適化**
   - 更新設定：自動更新間隔、手動更新ボタン
   - 表示設定（閉）：表示期間、グラフ編集、週間天気表示
   - アラート設定（閉）：各種警戒水位設定
   - システム情報（開）：
     - 観測状況（開）：観測時刻、データ件数
     - 警戒レベル説明（閉）
     - データソース（閉）

### 2025年6月26日 v2.2リリース
1. **データ品質改善**
   - 12時間表示期間が6時間分しか表示されない問題を修正
   - 降水強度観測値の時間範囲フィルタリング実装
   - 履歴データ読み込み時の72時間固定読み込み実装（表示期間変更時の再読み込み防止）
   - エラーファイルと日次サマリーファイルの削除（13件のエラー表示解消）

2. **UI/UX大幅改善**
   - サイドバーのシステム情報形式を統一（観測時刻 ： XX分前、データ件数 ： XX件）
   - データ分析グラフを2×2列レイアウトに変更
   - 全グラフの高さを465px、凡例位置をy=-0.30に統一
   - 週間天気予報のフォントサイズを18pxに統一
   - APIの値取得日時をシステム名の横に3列レイアウトで表示

3. **天気機能強化**
   - 週間天気予報に最高・最低気温を追加
   - 気象庁APIからの気温データ取得ロジックを改善（全timeSeriesから検索）
   - 下関エリア（81428）のサポート追加

4. **予測データ表示改善**
   - 降水強度予測値の表示ロジックを修正（30分以内の過去予測も表示）
   - Yahoo! Weather APIグラフからデバッグ情報を削除（クリーンな表示）

5. **GitHub Actions最適化**
   - 本番用スケジュール（10分間隔）に復帰
   - データ収集の競合問題を解決

### 2025年6月26日 v2.1リリース
1. **グラフスタイリング統一**
   - 全折れ線グラフのマーカーサイズを6pxに統一
   - 累加雨量グラフからマーカーを削除（背景塗りつぶしのみ）
   - ダム流入出量・累加雨量グラフの描画順序最適化（線グラフが塗りつぶしの上に表示）

2. **開発効率化**
   - GitHub Actions更新頻度を1時間間隔に変更（開発用）
   - データ収集とUI調整の両立を実現

### 2025年6月25日 v2.0リリース
1. **Yahoo! Weather API統合**
   - 降水強度データ（観測値・予測値）の追加
   - 座標: 131.289496,34.079891（厚東川ダム付近）
   - 天気予報機能の実装

2. **UI/UX大幅改善**
   - 固定ヘッダーの実装（システム名・監視状況常時表示）
   - レスポンシブデザイン対応（週間予報）
   - 河川情報と降雨情報の横並び配置
   - グラフレイアウトの統一とフォントサイズ標準化
   - サイドバー余白の最適化

3. **グラフ機能強化**
   - 4つのグラフの時間軸統一（将来予測値含む）
   - 双軸グラフ対応（降水強度・時間雨量）
   - マーカーサイズ・フォントサイズの統一
   - 凡例位置の最適化（下部左側配置）

4. **データ表示改善**
   - 河川ステータス表示の修正
   - 観測時刻表示の改善
   - 空行・重複表示の削除

### 2025年6月23日
1. **河川データ取得URL修正**
   - `kwl_graph.aspx` → `kwl_table.aspx`
   - テーブル形式での確実なデータ取得
   - パラメータ: `check=05067&obsdt=YYYYMMDDHHmm&pop=1`

2. **ダムデータ取得URL修正**
   - `kdm_graph.aspx` → `kdm_table.aspx`
   - テーブル形式での確実なデータ取得
   - パラメータ: `check=015&obsdt=YYYYMMDDHHmm&pop=1`

3. **時刻処理の改善**
   - 10分単位での丸め処理
   - データ公開遅延への対応（10分前のデータを取得）
   - 全ての時刻表示を日本時間（JST）に統一

4. **GitHub Actions間隔変更**
   - 10分間隔 → 10分間隔（毎時3,13,23,33,43,53分）
   - cron設定: `3,13,23,33,43,53 * * * *`（データ遅延対応）

5. **Streamlit読み込み問題の修正**
   - 履歴データ処理の最適化（最大100ファイル）
   - 自動更新の一時無効化
   - 新しいファイルから優先的に処理

6. **UI改善**
   - 河川情報セクションに観測日時を追加
   - 3列レイアウト（水位、観測地点、観測日時）

7. **手動データ更新スクリプト追加**
   - `scripts/update_latest_data.py`
   - GitHub Actions停止時の緊急対応用

## トラブルシューティング

### よくある問題

1. **データが更新されない**
   - GitHub Actionsの実行状況を確認
   - データソースのWebサイトアクセス状況を確認

2. **Streamlitが読み込み中のまま**
   - 履歴データが多すぎる場合がある
   - ブラウザキャッシュをクリア（Ctrl+F5）

3. **データ値が正しくない**
   - BeautifulSoupの解析パターンを確認
   - Webサイトの構造変更を確認

### デバッグ用スクリプト
```bash
# 手動でデータ取得
python scripts/save_current_webfetch_data.py

# データ収集テスト
python scripts/collect_data.py

# 最小版アプリテスト
streamlit run streamlit_app_minimal.py
```

## 連絡先・管理
- **Streamlit Cloud管理**: https://share.streamlit.io/
- **GitHub Actions管理**: https://github.com/dobocreate/kotogawa-monitor-streamlit/actions

## 現在の状態（2025年6月27日 15:00 JST）

### システム稼働状況
- **Streamlit App**: ✅ 稼働中（v2.4）
- **最新データ**: 2025-06-27 14:50 JST
- **GitHub Actions**: ✅ 10分間隔で正常稼働中
- **Yahoo! Weather API**: ✅ 正常稼働中

### 最新観測データ
- **ダム貯水位**: 36.88m (98.6%)
- **河川水位**: 2.82m (正常)
- **流入量**: 29.02 m³/s
- **全放流量**: 20.52 m³/s
- **時間雨量**: 0 mm/h（雨量データ取得成功）
- **降水強度**: 0.0 mm/h（観測値）
- **天気**: 晴れ

### 解決済み課題
1. ✅ GitHub Actions自動実行の安定化
2. ✅ UI/UXの大幅改善
3. ✅ 降水強度予測機能の追加
4. ✅ レスポンシブデザイン対応
5. ✅ 12時間表示期間の修正
6. ✅ エラーファイル削除による表示改善
7. ✅ 週間天気予報の気温表示追加
8. ✅ グラフレイアウトの2列化と高さ統一
9. ✅ モバイル対応（サイドバー初期非表示）
10. ✅ サイドバーUI全面改善
11. ✅ 免責事項の追加
12. ✅ 雨量データnull時のエラー処理改善
13. ✅ daily_summary機能の無効化
14. ✅ TypeErrorバグの修正（雨量アラートチェック）
15. ✅ モバイルサイドバー開閉問題の解決

## 今後の改善案
1. データ取得エラー時の通知機能
2. 過去データの統計分析機能
3. 長期予測機能の追加
4. アラート通知機能の強化
5. データ可視化の更なる改善
6. パフォーマンス最適化
7. ユーザビリティテストと改善